import random
import pymysql


class students_rank:
    def __init__(self):
        self.conn = pymysql.connect(host='localhost',
                               port=3306,
                               user='root',
                               passwd='boshuo',
                               database='成绩排名')
        self.cursor = self.conn.cursor()
    def data_formatting(self):
        sql = "TRUNCATE TABLE scores_rank"
        self.cursor.execute(sql)
        self.conn.commit()


    def data_entry(self):
        students = []
        for i in range(1,101):
            name=f"学生{i}"
            chinese_score = random.randint(40,150)
            math_score = random.randint(40,150)
            english_score = random.randint(40,150)
            total_score = chinese_score + math_score + english_score
            students.append({"name":name,"total_score":total_score,
                             "chinese_score":chinese_score,
                             "math_score":math_score,
                             "english_score":english_score})
        for student in students: 
            sql="INSERT INTO scores_rank(name,Chinese_scores,Math_scores,English_scores,Total_scores) VALUES(%s,%s,%s,%s,%s)"
            self.cursor.execute(sql,(student['name'],student['chinese_score'],student['math_score'],student['english_score'],student['total_score']))
        self.conn.commit()



    def data_operation(self):
       subjects = ["Chinese_scores","Math_scores","English_scores"]
       temp_table = ["chinese_rank","math_rank","english_rank"]
       for i,o in zip(subjects,temp_table):
            sql_chinese_temp = f"CREATE TEMPORARY TABLE {o} AS SELECT id, DENSE_RANK() OVER (ORDER BY {i} DESC) AS r FROM scores_rank"
            self.cursor.execute(sql_chinese_temp)
            sql_delete_scores = f"DELETE FROM scores_rank WHERE id IN (SELECT id FROM {o} WHERE r <=10)"
            self.cursor.execute(sql_delete_scores)
            self.conn.commit()

    def total_rank(self):
        sql = "SELECT * FROM scores_rank ORDER BY Total_scores DESC"
        self.cursor.execute(sql)
        self.conn.commit()
        results = self.cursor.fetchall()
        for row in results:
            print(row)

    def conn_close(self):
        self.cursor.close()
        self.conn.close()


s = students_rank()
while True:
    User_input = input("请输入要执行的操作(清空数据/生成数据/删除各科前十名/总分排序),输入'q'结束:")
    if User_input=='清空数据':
        s.data_formatting()
    elif User_input=='生成数据':
        s.data_entry()
    elif User_input=='删除各科前十名':
        s.data_operation()
    elif User_input=='总分排序':
        s.total_rank()
    elif User_input=='q':
        break
    else:
        print("您输入的操作有误")